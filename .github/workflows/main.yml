name: Main CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      build_image:
        description: 'Build Raspberry Pi image'
        required: false
        type: boolean
        default: true

jobs:
  # Linting and syntax checks
  lint:
    name: Lint and Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check shell script syntax
        run: |
          find scripts tests -name "*.sh" -type f | while read -r script; do
            echo "Checking: $script"
            if grep -qE "^@test|^#!/usr/bin/env bats|^#!/bin/bats" "$script"; then
              echo "Skipping BATS test file: $script"
              continue
            fi
            bash -n "$script" || exit 1
          done

      - name: Validate docker-compose.yml
        run: |
          if [ -f docker-compose.yml ]; then
            docker run --rm -v "$PWD:/data" -w /data \
              docker/compose:latest config --quiet
          fi

  # Python API tests
  python-tests:
    name: Python API Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r api/requirements.txt
          pip install pytest pytest-cov requests

      - name: Run API tests
        run: |
          cd tests/api
          pytest -v --cov=../../api --cov-report=term-missing

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # Bash script tests
  bash-tests:
    name: Bash Script Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install BATS
        run: |
          git clone https://github.com/bats-core/bats-core.git /tmp/bats
          sudo /tmp/bats/install.sh /usr/local

      - name: Run bash tests
        run: |
          chmod +x scripts/*.sh tests/**/*.sh
          ./scripts/run-tests.sh bash || true

  # Frontend tests (non-blocking)
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Run Vitest tests
        working-directory: web
        run: npm test || true

  # Playwright tests (non-blocking)
  playwright-tests:
    name: Playwright Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: web
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        working-directory: web
        run: npx playwright test || true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: web/playwright-report/
          retention-days: 30

  # Build Docker image
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, python-tests, bash-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (ARM64 for Raspberry Pi 5)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/arm64
          push: false
          load: true
          build-args: |
            MINECRAFT_VERSION=1.20.4
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Build Raspberry Pi image
  build-rpi-image:
    name: Build Raspberry Pi Image
    runs-on: ubuntu-latest
    needs: [build-docker]
    if: |
      github.event_name == 'workflow_dispatch' && inputs.build_image == true ||
      github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget \
            unzip \
            qemu-utils \
            kpartx \
            dosfstools \
            parted \
            rsync

      - name: Download Raspberry Pi OS Lite
        run: |
          # Download latest Raspberry Pi OS Lite (64-bit) image
          wget -q --show-progress \
            https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-$(date +%Y-%m-%d)/$(curl -s https://downloads.raspberrypi.com/raspios_lite_arm64/images/ | grep -oP 'raspios_lite_arm64-\K[0-9-]+' | head -1)/raspios_lite_arm64-$(curl -s https://downloads.raspberrypi.com/raspios_lite_arm64/images/ | grep -oP 'raspios_lite_arm64-\K[0-9-]+' | head -1).img.xz \
            -O raspios-lite.img.xz || \
          wget -q --show-progress \
            https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-2024-01-11/2024-01-11-raspios-bookworm-arm64-lite.img.xz \
            -O raspios-lite.img.xz

      - name: Extract image
        run: |
          unxz raspios-lite.img.xz
          mv *.img raspios-base.img

      - name: Resize image
        run: |
          # Resize image to accommodate our setup (minimum 4GB)
          qemu-img resize raspios-base.img 4G

      - name: Mount and customize image
        run: |
          # Create mount points
          sudo mkdir -p /mnt/rpi-boot /mnt/rpi-root

          # Get loop device
          LOOP_DEVICE=$(sudo losetup -f --show raspios-base.img)
          echo "Loop device: $LOOP_DEVICE"

          # Wait for partitions
          sleep 2

          # Mount partitions
          sudo partprobe $LOOP_DEVICE
          sleep 2

          BOOT_PARTITION="${LOOP_DEVICE}p1"
          ROOT_PARTITION="${LOOP_DEVICE}p2"

          sudo mount $BOOT_PARTITION /mnt/rpi-boot
          sudo mount $ROOT_PARTITION /mnt/rpi-root

          # Enable SSH
          sudo touch /mnt/rpi-boot/ssh

          # Configure WiFi (optional - can be customized)
          cat << EOF | sudo tee /mnt/rpi-boot/wpa_supplicant.conf > /dev/null
          ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
          update_config=1
          country=US

          # Uncomment and configure for WiFi:
           network={
               ssid="${{ secrets.WIFI_SSID }}"
               psk="${{ secrets.WIFI_PASSWORD }}"
           }
          EOF

          # Set hostname
          echo "minecraft-server" | sudo tee /mnt/rpi-root/etc/hostname

          # Create first-boot script
          cat << 'SCRIPT' | sudo tee /mnt/rpi-root/usr/local/bin/minecraft-firstboot.sh > /dev/null
          #!/bin/bash
          # First boot script for Minecraft Server setup

          set -e

          LOG_FILE="/var/log/minecraft-firstboot.log"
          exec > >(tee -a "$LOG_FILE") 2>&1

          echo "$(date): Starting Minecraft Server first boot setup..."

          # Update system
          apt-get update
          apt-get upgrade -y

          # Install Docker
          if ! command -v docker &> /dev/null; then
              curl -fsSL https://get.docker.com -o get-docker.sh
              sh get-docker.sh
              usermod -aG docker pi
              rm get-docker.sh
          fi

          # Install Docker Compose
          if ! command -v docker-compose &> /dev/null; then
              apt-get install -y docker-compose
          fi

          # Install additional utilities
          apt-get install -y git wget curl screen htop python3 python3-pip python3-venv

          # Install Node.js for web interface
          if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get install -y nodejs
          fi

          # Clone repository
          if [ ! -d "/home/pi/minecraft-server" ]; then
              cd /home/pi
              git clone https://github.com/${{ github.repository }}.git minecraft-server || \
              git clone https://github.com/and3rn3t/minecraft.git minecraft-server
              chown -R pi:pi minecraft-server
          fi

          # Run setup script
          if [ -f "/home/pi/minecraft-server/scripts/setup-rpi.sh" ]; then
              cd /home/pi/minecraft-server
              chmod +x scripts/setup-rpi.sh
              ./scripts/setup-rpi.sh
          fi

          # Disable this script from running again
          systemctl disable minecraft-firstboot.service
          rm /etc/systemd/system/minecraft-firstboot.service
          systemctl daemon-reload

          echo "$(date): First boot setup completed successfully!"
          SCRIPT

          sudo chmod +x /mnt/rpi-root/usr/local/bin/minecraft-firstboot.sh

          # Create systemd service for first boot
          cat << 'SERVICE' | sudo tee /mnt/rpi-root/etc/systemd/system/minecraft-firstboot.service > /dev/null
          [Unit]
          Description=Minecraft Server First Boot Setup
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/minecraft-firstboot.sh
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target
          SERVICE

          sudo ln -sf /etc/systemd/system/minecraft-firstboot.service \
            /mnt/rpi-root/etc/systemd/system/multi-user.target.wants/minecraft-firstboot.service

          # Unmount
          sudo umount /mnt/rpi-boot
          sudo umount /mnt/rpi-root
          sudo losetup -d $LOOP_DEVICE

      - name: Compress image
        run: |
          # Create final image name with version/tag
          IMAGE_NAME="minecraft-server-rpi5-$(date +%Y%m%d)"
          if [ "${{ github.ref_type }}" = "tag" ]; then
            IMAGE_NAME="minecraft-server-rpi5-${GITHUB_REF#refs/tags/v}"
          fi

          # Compress image
          xz -9 -T0 raspios-base.img
          mv raspios-base.img.xz "${IMAGE_NAME}.img.xz"

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: raspberry-pi-image
          path: |
            *.img.xz
            *.img
          retention-days: 90

      - name: Create release (if tag)
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          files: |
            *.img.xz
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Summary job
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [lint, python-tests, bash-tests, frontend-tests, playwright-tests, build-docker]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Tests | ${{ needs.python-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bash Tests | ${{ needs.bash-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | ${{ needs.frontend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Playwright Tests | ${{ needs.playwright-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.build-docker.result }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.python-tests.result }}" != "success" ] || \
             [ "${{ needs.bash-tests.result }}" != "success" ] || \
             [ "${{ needs.build-docker.result }}" != "success" ]; then
            echo "❌ Critical jobs failed!" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ All critical jobs passed!" >> $GITHUB_STEP_SUMMARY
          fi
